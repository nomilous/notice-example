// Generated by CoffeeScript 1.6.3
var Client, MessageBus, tools;

MessageBus = require('./server/message_bus').MessageBus;

Client = require('dinkum').Client;

tools = require('notice').tools;

exports.start = function(callback) {
  return MessageBus.create({
    title: 'Message Bus Title',
    uuid: 1,
    listen: {
      secret: 'âˆ†',
      adaptor: 'socket.io',
      port: 10001
    },
    ticks: {
      TEST: {}
    },
    cache: {
      'preloaded-key': {}
    },
    tools: {
      elastic: Client.create({
        transport: 'http',
        port: 9200
      }),
      "class": new tools.NoticeableClass,
      'closure-example': tools.NoticeableClosure.create()
    }
  }, function(error, hub) {
    if (error != null) {
      return callback(error);
    }
    hub.use({
      title: 'initializer',
      description: "First middleware is usefull for filtering builtin control capsules."
    }, function(next, capsule, traveral) {
      console.log(capsule);
      if (capsule.$$control != null) {
        return next.cancel();
      }
      return next();
    });
    hub.use({
      title: 'client health'
    }, function(next, capsule, _arg) {
      var origin, tools;
      origin = _arg.origin, tools = _arg.tools;
      if (capsule.health == null) {
        return next();
      }
      tools.elastic.post({
        path: '/test-database/health',
        'application/json': {
          hostname: origin.context.hostname,
          timestamp: capsule.timestamp,
          memory: capsule
        }
      }).then(function(r) {
        return console.log(r);
      });
      return next();
    });
    hub.use({
      title: 'testing things'
    }, function(next, capsule, _arg) {
      var tools;
      tools = _arg.tools;
      return next();
    });
    hub.use({
      title: 'example',
      description: "A second middleware to play with."
    }, function(next, capsule, _arg) {
      var cache, tools;
      tools = _arg.tools, cache = _arg.cache;
      return next();
    });
    return callback(null, hub);
  });
};
